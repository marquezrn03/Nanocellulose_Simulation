<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nanocellulose Digital Twin - PhD Level</title>
    <style>
        :root {
            --bg: #030407;
            --panel: rgba(10, 14, 20, 0.88);
            --primary: #00e5ff;
            --accent: #ff0055;
            --text-main: #f1f5f9;
            --text-muted: #8b9bb4;
            --border: rgba(255, 255, 255, 0.15);
            
            /* Composition Colors */
            --c-cel: #e2e8f0;
            --c-hem: #d4b85c;
            --c-lig: #8b5a2b;
        }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background: var(--bg); font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-main); user-select: none;
        }

        /* 3D Canvas captures model rotation/zoom, blocks page scroll */
        #canvas-container { position: absolute; inset: 0; z-index: 1; touch-action: none; }

        /* Sidebar UI */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 400px; height: 100vh;
            background: var(--panel); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border-right: 1px solid var(--border); z-index: 10;
            display: flex; flex-direction: column;
            box-shadow: 10px 0 50px rgba(0,0,0,0.8);
            transition: all 0.3s ease-in-out;
        }

        .header { padding: 20px 24px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.3); position: relative; flex-shrink: 0;}
        .header h1 { margin: 0; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #fff;}
        .header p { margin: 4px 0 0; font-size: 0.75rem; color: var(--primary); font-family: monospace; letter-spacing: 0.5px;}
        .badge { position: absolute; top: 22px; right: 24px; background: rgba(0,229,255,0.1); border: 1px solid var(--primary); color: var(--primary); font-size: 0.6rem; padding: 3px 6px; border-radius: 4px; font-weight: bold; letter-spacing: 1px; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,229,255,0.4); } 70% { box-shadow: 0 0 0 6px rgba(0,229,255,0); } 100% { box-shadow: 0 0 0 0 rgba(0,229,255,0); } }

        /* Controls Area allows native scrolling on touch devices */
        .controls { flex: 1; overflow-y: auto; padding: 24px; touch-action: pan-y; }
        .controls::-webkit-scrollbar { width: 6px; }
        .controls::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        .step {
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px; padding: 18px; margin-bottom: 20px;
        }

        .step-title {
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px; color: #fff; margin-bottom: 16px;
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;
        }

        .row { margin-bottom: 16px; }
        .row:last-child { margin-bottom: 0; }
        
        .label { display: flex; justify-content: space-between; align-items:flex-end; font-size: 0.75rem; margin-bottom: 8px; color: var(--text-muted); }
        .label-title { font-weight: 600; color: #ccc; }
        .val { color: var(--primary); font-family: monospace; font-weight: bold; font-size: 0.8rem; text-align: right;}

        /* Composition Bar */
        .comp-display { margin-bottom: 20px; }
        .comp-bar {
            display: flex; height: 16px; border-radius: 8px; overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); border: 1px solid var(--border);
        }
        .comp-segment { height: 100%; transition: width 0.3s ease; }
        .c-cel { background: var(--c-cel); width: 45%; }
        .c-hem { background: var(--c-hem); width: 25%; }
        .c-lig { background: var(--c-lig); width: 30%; }

        .legend { display: flex; justify-content: space-between; font-size: 0.7rem; margin-top: 8px; color: var(--text-muted); font-family: monospace;}
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        select, input[type=range] { width: 100%; }
        select {
            background: rgba(0,0,0,0.4); color: #fff; border: 1px solid var(--border);
            padding: 10px 12px; border-radius: 6px; font-size: 0.85rem; outline: none; margin-bottom: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type=range] { -webkit-appearance: none; background: transparent; padding: 5px 0; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: rgba(255,255,255,0.08); border-radius: 3px; border: 1px solid rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: var(--primary); margin-top: -7px; cursor: pointer;
            box-shadow: 0 0 12px rgba(0, 229, 255, 0.4); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }

        /* Analytics Overlay */
        #analytics {
            position: absolute; top: 24px; right: 24px; width: 340px;
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 8px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: -5px 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s ease-in-out;
        }
        .stat-section { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stat-section:last-child { border-bottom: none; background: rgba(0,229,255,0.02); }
        
        .stat-header { font-size: 0.7rem; color: #fff; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px;}
        .stat-header::before { content: ''; display: block; width: 4px; height: 12px; background: var(--primary); border-radius: 2px;}
        
        .stat-line { display: flex; justify-content: space-between; align-items: flex-end; font-size: 0.8rem; margin-bottom: 8px; }
        .stat-line:last-child { margin-bottom: 0; }
        .stat-label { color: var(--text-muted); }
        .stat-line span:last-child { color: var(--primary); font-family: monospace; font-weight: bold; font-size: 0.9rem; text-align: right;}

        .app-box { margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; border: 1px dashed rgba(255,255,255,0.1); font-size: 0.75rem; line-height: 1.4; color: #cbd5e1; }
        .app-title { font-weight: 700; color: #fff; margin-bottom: 4px; display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;}

        #warning-box {
            display: none; margin-top: 14px; padding: 12px; background: rgba(255, 0, 85, 0.15);
            border-radius: 6px; border: 2px solid #ff0055; font-size: 0.75rem;
            line-height: 1.4; color: #ffbbcc; text-align: center;
        }

        #loader {
            position: fixed; inset: 0; background: var(--bg); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--primary); font-family: monospace; letter-spacing: 2px; transition: opacity 0.5s;
        }
        .spinner { width: 50px; height: 50px; border: 2px solid rgba(0,229,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Tablet Layout */
        @media (max-width: 1024px) {
            #ui-panel { width: 340px; }
            #analytics { width: 300px; top: env(safe-area-inset-top, 16px); right: env(safe-area-inset-right, 16px); }
            .header { padding: 16px 20px; }
            .controls { padding: 20px; }
            .stat-line { font-size: 0.75rem; }
        }

        /* Mobile Landscape */
        @media (max-width: 950px) and (orientation: landscape) {
            #ui-panel {
                width: 280px; height: 100vh; height: 100dvh; top: 0; bottom: auto;
                border-radius: 0; border-right: 1px solid var(--border); border-top: none;
                padding-left: env(safe-area-inset-left, 0); padding-bottom: env(safe-area-inset-bottom, 0);
            }
            #analytics {
                top: env(safe-area-inset-top, 10px); right: env(safe-area-inset-right, 10px); 
                left: auto; width: 260px; max-height: 90dvh;
                background: rgba(10, 14, 20, 0.4); pointer-events: none;
            }
            .stat-section { padding: 10px; }
            .stat-line { font-size: 0.7rem; margin-bottom: 4px; }
            .app-box { font-size: 0.65rem; padding: 6px; margin-top: 6px; }
            .controls { padding: 12px; }
            .step { padding: 12px; margin-bottom: 12px; }
            .step-title { font-size: 0.7rem; margin-bottom: 8px; }
            input[type=range]::-webkit-slider-thumb { height: 24px; width: 24px; margin-top: -9px; }
        }

        /* Mobile Portrait */
        @media (max-width: 768px) and (orientation: portrait) {
            #ui-panel {
                width: 100%; height: 50vh; height: 50dvh; top: auto; bottom: 0;
                border-right: none; border-top: 1px solid var(--border);
                border-radius: 20px 20px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
            .header { padding: 12px 20px; border-radius: 20px 20px 0 0; }
            .header h1 { font-size: 1.0rem; }
            
            #analytics {
                top: env(safe-area-inset-top, 10px); left: env(safe-area-inset-left, 10px); right: env(safe-area-inset-right, 10px); 
                width: auto; background: rgba(10, 14, 20, 0.4); pointer-events: none; 
                max-height: 48dvh; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            }
            
            .stat-section { padding: 8px 12px; }
            .stat-header { font-size: 0.6rem; margin-bottom: 6px; }
            .stat-line { font-size: 0.65rem; margin-bottom: 4px; }
            .stat-line span:last-child { font-size: 0.75rem; }
            .app-box { font-size: 0.6rem; padding: 6px; margin-top: 6px; }
            #warning-box { padding: 6px; font-size: 0.6rem; margin-top: 6px; }

            input[type=range]::-webkit-slider-thumb { height: 24px; width: 24px; margin-top: -9px; }
        }

        /* Small Mobile Adjustments */
        @media (max-width: 480px) and (orientation: portrait) {
            #ui-panel { height: 55vh; height: 55dvh; }
            .controls { padding: 12px; }
            .step { padding: 12px; margin-bottom: 12px; }
            .step-title { font-size: 0.7rem; margin-bottom: 10px; }
            .label { font-size: 0.65rem; flex-direction: column; align-items: flex-start; gap: 4px; }
            .val { align-self: flex-start; }
            select { padding: 8px 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div>COMPUTING NATIVE CELLULOSE Iβ ARCHITECTURE...</div>
    <div id="canvas-container"></div>

    <div id="analytics">
        <div class="stat-section">
            <div class="stat-header">Suspension Analytics</div>
            <div class="stat-line"><span class="stat-label">Kappa Number (Lignin):</span> <span id="stat-kappa">195.0</span></div>
            <div class="stat-line"><span class="stat-label">Zeta Potential:</span> <span id="stat-zeta">0 mV</span></div>
            <div class="stat-line"><span class="stat-label">Morphology:</span> <span id="stat-morph" style="color: #fff;">Intact Wood Fiber</span></div>
            <div class="stat-line"><span class="stat-label">Est. Aspect Ratio (L/d):</span> <span id="stat-ar">~ 10</span></div>
        </div>
        <div class="stat-section">
            <div class="stat-header">Predicted Film Properties</div>
            <div class="stat-line"><span class="stat-label">Tensile Strength:</span> <span id="stat-ts">45 MPa</span></div>
            <div class="stat-line"><span class="stat-label">Elastic Modulus:</span> <span id="stat-ym">3.5 GPa</span></div>
            <div class="stat-line"><span class="stat-label">Strain at Break:</span> <span id="stat-strain">2.0 %</span></div>
            
            <div class="app-box">
                <span class="app-title">Primary Industrial Application</span>
                <span id="stat-app">Standard paper products, cardboard, packaging. Low nanoscale functionality.</span>
            </div>

            <div id="warning-box">
                ⚠️ <strong>RISK OF ENZYMATIC HYDROLYSIS</strong><br>High enzyme dosages significantly increase the risk of severe cellulose depolymerization and structural degradation.
            </div>
        </div>
    </div>

    <div id="ui-panel">
        <div class="header">
            <h1>Nanocellulose Lab</h1>
            <p>Digital Twin Physics Engine</p>
            <div class="badge">LIVE</div>
        </div>
        <div class="controls">
            
            <div class="step">
                <div class="step-title">1. Biomass & Chemistry</div>
                
                <select id="sel-biomass">
                    <option value="softwood">Softwood (High Lignin, High CrI)</option>
                    <option value="hardwood">Hardwood (Med Lignin, Med CrI)</option>
                    <option value="cotton">Cotton Linters (Pure Cellulose)</option>
                </select>

                <div class="comp-display">
                    <div class="comp-bar">
                        <div class="comp-segment c-cel" id="bar-cel"></div>
                        <div class="comp-segment c-hem" id="bar-hem"></div>
                        <div class="comp-segment c-lig" id="bar-lig"></div>
                    </div>
                    <div class="legend">
                        <div class="legend-item"><div class="dot" style="background:var(--c-cel)"></div> Cel (<span id="pct-cel">45</span>%)</div>
                        <div class="legend-item"><div class="dot" style="background:var(--c-hem)"></div> Hem (<span id="pct-hem">25</span>%)</div>
                        <div class="legend-item"><div class="dot" style="background:var(--c-lig)"></div> Lig (<span id="pct-lig">30</span>%)</div>
                    </div>
                </div>

                <div class="row">
                    <div class="label">
                        <span class="label-title">Kraft Pulping</span>
                        <span class="val" id="val-pulp">AA: 0%, 20°C</span>
                    </div>
                    <input type="range" id="slider-pulp" min="0" max="1" step="0.01" value="0">
                </div>
                <div class="row">
                    <div class="label" style="margin-bottom: 4px;">
                        <span class="label-title">Bleaching Sequence</span>
                    </div>
                    <select id="sel-bleach-type">
                        <option value="ecf">ECF (D-E-D) - Chlorine Dioxide</option>
                        <option value="tcf-h2o2">TCF (P-Q-P) - Hydrogen Peroxide</option>
                        <option value="tcf-o3">TCF (Z-E-P) - Ozone</option>
                    </select>
                    <div class="label" style="margin-top: 10px;">
                        <span class="label-title">Chemical Charge</span>
                        <span class="val" id="val-bleach">0% ClO₂</span>
                    </div>
                    <input type="range" id="slider-bleach" min="0" max="1" step="0.01" value="0">
                </div>
            </div>

            <div class="step">
                <div class="step-title">2. Nanoscale Pretreatment</div>
                <select id="sel-pre">
                    <option value="none">None (Mechanical Only)</option>
                    <option value="tempo">TEMPO Oxidation (NaOCl)</option>
                    <option value="cationic">Cationization (CHPTAC/NaOH)</option>
                    <option value="enzyme">Enzymatic (Endoglucanases)</option>
                </select>
                <div class="row">
                    <div class="label">
                        <span class="label-title" id="lbl-pre-deg">Treatment Intensity</span>
                        <span class="val" id="val-pre-deg">-</span>
                    </div>
                    <input type="range" id="slider-pre-deg" min="0" max="1" step="0.01" value="0">
                </div>
            </div>

            <div class="step">
                <div class="step-title">3. Mechanical Processing</div>
                <select id="sel-mech">
                    <option value="grinder">Masuko Grinder (Friction/Shear)</option>
                    <option value="hph">High-Pressure Homogenizer (Impact)</option>
                    <option value="super">Supermasscolloider (Chaotic Shear)</option>
                </select>
                <div class="row">
                    <div class="label">
                        <span class="label-title">Specific Energy Input</span>
                        <span class="val" id="val-energy">0 kWh/t</span>
                    </div>
                    <input type="range" id="slider-energy" min="0" max="1" step="0.01" value="0">
                </div>
            </div>

            <div class="step" style="margin-bottom: 20px;">
                <div class="step-title">4. Functionalization</div>
                <select id="sel-post">
                    <option value="none">None (Pure Nanocellulose)</option>
                    <option value="laccase">Laccase Lignin Polymerization</option>
                    <option value="polymer">PVA/PLA Polymer Matrix</option>
                    <option value="ions">Cationic Polymer Treatment</option>
                </select>
                <div class="row">
                    <div class="label">
                        <span class="label-title" id="lbl-post-deg">Addition Level</span>
                        <span class="val" id="val-post-deg">-</span>
                    </div>
                    <input type="range" id="slider-post-deg" min="0" max="1" step="0.01" value="0">
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        const BIOMASS_TYPES = {
            softwood: { cel: 45, hem: 25, lig: 30, cri: 0.65 },
            hardwood: { cel: 48, hem: 30, lig: 22, cri: 0.60 },
            cotton:   { cel: 98, hem: 1.5, lig: 0.5, cri: 0.85 }
        };

        const state = {
            rawBiomass: 'softwood', pulping: 0, bleaching: 0, bleachType: 'ecf',
            preType: 'none', preDeg: 0, mechType: 'grinder', energy: 0,
            postType: 'none', postDeg: 0,
            comp: { cel: 45, hem: 25, lig: 30 }, relComp: { cel: 45, hem: 25, lig: 30 },
            kappa: 195, zetaPotential: 0, time: 0,
            morphology: '', aspect: 10
        };

        const PARAMS = { 
            FIBERS: 160,       // High density
            BUNDLES: 8,        // Hierarchical microfibrillar bands
            SEGMENTS: 50, 
            RADIUS: 7.5, 
            HEIGHT: 110.0 
        };
        const TOTAL = PARAMS.FIBERS * PARAMS.SEGMENTS;
        const $ = id => document.getElementById(id);

        function formatPretreatment() {
            if(state.preType === 'none') { $('lbl-pre-deg').textContent = 'N/A'; $('val-pre-deg').textContent = '-'; }
            else if(state.preType === 'tempo') { $('lbl-pre-deg').textContent = 'Carboxyl Content'; $('val-pre-deg').textContent = (state.preDeg * 1.5).toFixed(2) + ' mmol/g'; }
            else if(state.preType === 'cationic') { $('lbl-pre-deg').textContent = 'Degree of Substitution'; $('val-pre-deg').textContent = 'DS ' + (state.preDeg * 0.3).toFixed(2); }
            else if(state.preType === 'enzyme') { $('lbl-pre-deg').textContent = 'Enzyme Dose'; $('val-pre-deg').textContent = (state.preDeg * 50).toFixed(1) + ' FPU/g'; }
        }

        function formatEnergy() {
            if(state.mechType === 'grinder' || state.mechType === 'super') {
                const maxE = state.mechType === 'grinder' ? 25000 : 35000;
                $('val-energy').textContent = Math.round(state.energy * maxE).toLocaleString() + ' kWh/t';
            } else if (state.mechType === 'hph') {
                const passes = Math.ceil(state.energy * 20);
                const pressure = Math.round(state.energy * 1500 + 500);
                if(state.energy === 0) $('val-energy').textContent = '0 bar, 0 passes';
                else $('val-energy').textContent = `${pressure} bar, ${passes} passes`;
            }
        }

        function formatPost() {
            if(state.postType === 'none') { $('lbl-post-deg').textContent = 'N/A'; $('val-post-deg').textContent = '-'; }
            else if(state.postType === 'laccase') { $('lbl-post-deg').textContent = 'Grafting Yield'; $('val-post-deg').textContent = (state.postDeg * 15).toFixed(1) + ' wt%'; }
            else if(state.postType === 'polymer') { $('lbl-post-deg').textContent = 'Matrix Loading'; $('val-post-deg').textContent = (state.postDeg * 80).toFixed(0) + ' wt%'; }
            else if(state.postType === 'ions') { $('lbl-post-deg').textContent = 'Adsorption Level'; $('val-post-deg').textContent = (state.postDeg * 120).toFixed(0) + ' mg/g'; }
        }

        function updateComposition() {
            const raw = BIOMASS_TYPES[state.rawBiomass];
            const ligPulp = raw.lig * (1 - state.pulping * 0.95);
            const hemPulp = raw.hem * (1 - state.pulping * 0.50);
            
            state.comp.lig = ligPulp * (1 - state.bleaching * 1.0);
            state.comp.hem = hemPulp * (1 - state.bleaching * 0.3);
            state.comp.cel = raw.cel; 

            const total = state.comp.lig + state.comp.hem + state.comp.cel;
            state.relComp.cel = (state.comp.cel / total) * 100;
            state.relComp.hem = (state.comp.hem / total) * 100;
            state.relComp.lig = (state.comp.lig / total) * 100;

            $('bar-cel').style.width = state.relComp.cel + '%';
            $('bar-hem').style.width = state.relComp.hem + '%';
            $('bar-lig').style.width = state.relComp.lig + '%';
            $('pct-cel').textContent = state.relComp.cel.toFixed(1);
            $('pct-hem').textContent = state.relComp.hem.toFixed(1);
            $('pct-lig').textContent = state.relComp.lig.toFixed(1);

            state.kappa = state.relComp.lig * 6.5;
            $('stat-kappa').textContent = state.kappa.toFixed(1);

            const aa = 12 + (state.pulping * 10);
            const temp = 20 + (state.pulping * 150);
            $('val-pulp').textContent = `AA: ${aa.toFixed(1)}%, ${Math.round(temp)}°C`;
            
            if (state.bleachType === 'ecf') $('val-bleach').textContent = (state.bleaching * 4.5).toFixed(1) + '% ClO₂';
            else if (state.bleachType === 'tcf-h2o2') $('val-bleach').textContent = (state.bleaching * 6.0).toFixed(1) + '% H₂O₂';
            else if (state.bleachType === 'tcf-o3') $('val-bleach').textContent = (state.bleaching * 1.5).toFixed(1) + '% O₃';

            updateShellColors();
        }

        $('sel-biomass').addEventListener('change', e => { state.rawBiomass = e.target.value; updateComposition(); buildArchitecture(); });
        $('sel-bleach-type').addEventListener('change', e => { state.bleachType = e.target.value; updateComposition(); });
        $('sel-pre').addEventListener('change', e => { state.preType = e.target.value; formatPretreatment(); });
        $('sel-mech').addEventListener('change', e => { state.mechType = e.target.value; formatEnergy(); });
        $('sel-post').addEventListener('change', e => { state.postType = e.target.value; formatPost(); updatePostColors(); });
        $('slider-pulp').addEventListener('input', e => { state.pulping = parseFloat(e.target.value); updateComposition(); });
        $('slider-bleach').addEventListener('input', e => { state.bleaching = parseFloat(e.target.value); updateComposition(); });
        $('slider-pre-deg').addEventListener('input', e => { state.preDeg = parseFloat(e.target.value); formatPretreatment(); });
        $('slider-energy').addEventListener('input', e => { state.energy = parseFloat(e.target.value); formatEnergy(); });
        $('slider-post-deg').addEventListener('input', e => { state.postDeg = parseFloat(e.target.value); formatPost(); });

        let scene, camera, renderer, controls;
        let cellMesh, shellMesh, postMesh;
        const fibrilData = []; 
        const isCrystal = new Uint8Array(TOTAL);
        const dummy = new THREE.Object3D();

        function initScene() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x030407, 0.003);

            camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 1500);
            camera.position.set(0, 0, 160);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            $('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.dampingFactor = 0.05;
            controls.autoRotate = true; controls.autoRotateSpeed = 0.3;

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const keyLight = new THREE.DirectionalLight(0xffffff, 1.8); keyLight.position.set(40, 60, 50); scene.add(keyLight);
            const fillLight = new THREE.DirectionalLight(0xaaccff, 0.8); fillLight.position.set(-50, -20, -30); scene.add(fillLight);
            const rimLight = new THREE.DirectionalLight(0xffeedd, 1.2); rimLight.position.set(20, 30, -50); scene.add(rimLight);

            // 4-sided cylinder (Square/Diamond) to represent native Iβ cellulose crystal planes (110 and 200)
            const geo = new THREE.CylinderGeometry(0.16, 0.16, 1, 4); 
            geo.rotateX(Math.PI/2); geo.rotateZ(Math.PI/4); geo.translate(0, 0, 0.5);
            
            const matC = new THREE.MeshPhysicalMaterial({ color: 0xffffff, roughness: 0.15, transmission: 0.8, thickness: 0.5, clearcoat: 1.0 });
            cellMesh = new THREE.InstancedMesh(geo, matC, TOTAL); cellMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage); scene.add(cellMesh);

            const matS = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.95 });
            shellMesh = new THREE.InstancedMesh(geo, matS, TOTAL); shellMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage); scene.add(shellMesh);

            const geoP = new THREE.SphereGeometry(0.3, 8, 8);
            const matP = new THREE.MeshPhysicalMaterial({ color: 0xffffff, roughness: 0.5 });
            postMesh = new THREE.InstancedMesh(geoP, matP, TOTAL); postMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage); scene.add(postMesh);

            window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        }

        function buildArchitecture() {
            fibrilData.length = 0;
            const cri = BIOMASS_TYPES[state.rawBiomass].cri;

            // Hierarchical Architecture: Microfibrillar bands -> Elementary Fibrils
            // PERFECTLY STRAIGHT PARALLEL ALIGNMENT
            for (let i = 0; i < PARAMS.FIBERS; i++) {
                const bundleId = i % PARAMS.BUNDLES;
                const bandAngle = (bundleId / PARAMS.BUNDLES) * Math.PI * 2;
                const bandRadius = PARAMS.RADIUS * 0.65;
                const bX = Math.cos(bandAngle) * bandRadius;
                const bZ = Math.sin(bandAngle) * bandRadius;

                const localRadius = (PARAMS.RADIUS * 0.4) * Math.sqrt(Math.random());
                const localAngle = Math.random() * Math.PI * 2;
                const lX = Math.cos(localAngle) * localRadius;
                const lZ = Math.sin(localAngle) * localRadius;

                fibrilData.push({ 
                    id: i, bX: bX, bZ: bZ, lX: lX, lZ: lZ,
                    phase: Math.random() * 10 
                });
            }

            const colCryst = new THREE.Color(0xffffff);
            const colAmorph = new THREE.Color(0xaabbdd); 
            let idx = 0;
            const cycleLen = Math.floor(8 + (cri * 12)); const thresh = cycleLen * cri;

            for(let i=0; i<PARAMS.FIBERS; i++) {
                for(let j=0; j<PARAMS.SEGMENTS; j++) {
                    const cryst = (j % cycleLen) < thresh ? 1 : 0;
                    isCrystal[idx] = cryst;
                    cellMesh.setColorAt(idx, cryst ? colCryst : colAmorph);
                    idx++;
                }
            }
            cellMesh.instanceColor.needsUpdate = true;
            updateShellColors();
        }

        function updateShellColors() {
            const colLig = new THREE.Color(0x4a2c16); const colHem = new THREE.Color(0xb59c4a); const colBleach = new THREE.Color(0xffffff);
            colLig.lerp(colBleach, state.bleaching); colHem.lerp(colBleach, state.bleaching);
            let idx = 0;
            for(let i=0; i<PARAMS.FIBERS; i++) {
                const baseCol = (i % 3 === 0) ? colLig : colHem;
                for(let j=0; j<PARAMS.SEGMENTS; j++) { shellMesh.setColorAt(idx++, baseCol); }
            }
            shellMesh.instanceColor.needsUpdate = true;
        }

        function updatePostColors() {
            if (state.postType === 'laccase') { postMesh.material.color.setHex(0x3e2723); postMesh.material.transparent = false; } 
            else if (state.postType === 'polymer') { postMesh.material.color.setHex(0x00ffcc); postMesh.material.transparent = true; postMesh.material.opacity = 0.5; } 
            else if (state.postType === 'ions') { postMesh.material.color.setHex(0xff00cc); postMesh.material.transparent = false; }
        }

        function updatePhysics() {
            state.time += 0.015; const t = state.time;

            let zeta = 0;
            if (state.preType === 'tempo') zeta = -60 * state.preDeg;
            if (state.preType === 'cationic') zeta = +50 * state.preDeg;
            if (state.preType === 'enzyme') zeta = -10 * state.preDeg;
            state.zetaPotential = zeta;

            const ligninBlock = Math.min(1.0, state.relComp.lig / 12.0); 
            const hemiBoost = state.relComp.hem / 25.0; 
            let effectiveEnergy = state.energy * (1.0 - ligninBlock) * (1.0 + hemiBoost * 0.2);

            let enzymeFacilitation = 0;
            if (state.preType === 'enzyme') {
                enzymeFacilitation = state.preDeg * 2.0; 
                effectiveEnergy *= (1.0 + enzymeFacilitation);
            }

            const chargeRepulsion = Math.abs(zeta) / 60; 
            effectiveEnergy = Math.min(1.0, effectiveEnergy + (chargeRepulsion * state.energy * 2.5));
            const staticSwelling = chargeRepulsion * 0.5;

            let idx = 0;

            for (let i = 0; i < PARAMS.FIBERS; i++) {
                const f = fibrilData[i];
                // Distance from center determines peeling ease
                const layerFactor = Math.sqrt(f.bX*f.bX + f.bZ*f.bZ) / PARAMS.RADIUS; 
                const peel = Math.pow(effectiveEnergy, 1.5) * layerFactor;
                
                const getPos = (segIndex, isCryst) => {
                    const sY = (segIndex / (PARAMS.SEGMENTS - 1)) * PARAMS.HEIGHT - (PARAMS.HEIGHT / 2);
                    const vFray = Math.abs(sY) / (PARAMS.HEIGHT / 2);
                    const lPeel = peel * (0.2 + 0.8 * vFray);
                    
                    // Expand Microfibrillar Bands (Macro-peel)
                    const bandSpread = (lPeel * 20.0) + (staticSwelling * 5.0);
                    const currentBx = f.bX * (1 + bandSpread / PARAMS.RADIUS);
                    const currentBz = f.bZ * (1 + bandSpread / PARAMS.RADIUS);

                    // Expand Elementary Fibrils within Bands (Micro-peel)
                    const fibrilSpread = Math.max(0, lPeel - 0.2) * 25.0 + (staticSwelling * 5.0);
                    const currentLx = f.lX * (1 + fibrilSpread / (PARAMS.RADIUS*0.4));
                    const currentLz = f.lZ * (1 + fibrilSpread / (PARAMS.RADIUS*0.4));

                    // PERFECTLY PARALLEL (No Macroscopic Twist)
                    let pX = currentBx + currentLx;
                    let pZ = currentBz + currentLz;
                    let pY = sY;

                    if (effectiveEnergy > 0 || staticSwelling > 0) {
                        // Crystalline regions resist bending!
                        // This makes the fibril behave like rigid rods connected by flexible hinges
                        const stiffness = isCryst ? 0.2 : 1.0; 
                        
                        pX += Math.sin(t + f.phase) * (lPeel * 2) * stiffness;
                        pZ += Math.cos(t * 0.8 + f.phase) * (lPeel * 2) * stiffness;
                        
                        if (state.mechType === 'grinder') {
                            const tangle = lPeel * 14 * (1 - chargeRepulsion * 0.6) * stiffness;
                            pX += Math.sin(pY * 0.15 + f.phase) * tangle; 
                            pZ += Math.cos(pY * 0.12 + f.phase) * tangle;
                        } else if (state.mechType === 'hph') {
                            pX += Math.sin(pY * 0.05 + f.phase) * lPeel * 3 * stiffness;
                        } else if (state.mechType === 'super') {
                            const chaos = lPeel * 22 * (1 - chargeRepulsion * 0.4) * stiffness;
                            pX += Math.sin(pY * 0.4 + f.phase) * chaos; 
                            pZ += Math.cos(pY * 0.35 + f.phase) * chaos; 
                            pY += Math.sin(pX * 0.2) * chaos * 0.5;
                        }
                    }
                    return { x: pX, y: pY, z: pZ, lPeel: lPeel };
                };

                for (let j = 0; j < PARAMS.SEGMENTS; j++) {
                    const cryst = isCrystal[idx];
                    const pos1 = getPos(j, cryst); 
                    let x = pos1.x, y = pos1.y, z = pos1.z; 
                    const localPeel = pos1.lPeel;
                    
                    let zMult = 1.0; let scaleX = 1.0; let broken = false; 

                    if (state.preType === 'enzyme' && !cryst) {
                        const digest = 1.0 - (state.preDeg * 1.5);
                        scaleX *= Math.max(0.1, digest); zMult *= Math.max(0.1, digest);
                        if (state.preDeg >= 0.08) {
                            const breakProb = (state.preDeg - 0.08) * 2.5; 
                            const enzHash = (f.id * 31 + j * 17) % 100 / 100;
                            if (enzHash < breakProb) broken = true;
                        }
                    }
                    if (state.mechType === 'hph' && effectiveEnergy > 0 && !cryst) {
                        if (((f.id * 7 + j * 13) % 100 / 100) < effectiveEnergy * 0.8 * (1 - state.relComp.hem / 100)) broken = true;
                    }
                    if (state.mechType === 'super' && effectiveEnergy > 0) {
                        if (((f.id * 11 + j * 17) % 100 / 100) < effectiveEnergy * 0.6) broken = true;
                    }
                    if (broken) zMult = 0.1;
                    scaleX *= Math.max(0.12, 1.0 - (localPeel * 0.7));

                    dummy.position.set(x, y, z);
                    let dist = PARAMS.HEIGHT / PARAMS.SEGMENTS; 
                    if (j < PARAMS.SEGMENTS - 1 && !broken) {
                        // Check crystallinity of NEXT node for proper lookAt interpolation
                        const nextCryst = isCrystal[idx + 1];
                        const pos2 = getPos(j+1, nextCryst); 
                        dummy.lookAt(pos2.x, pos2.y, pos2.z);
                        dist = Math.sqrt(Math.pow(pos2.x-x,2) + Math.pow(pos2.y-y,2) + Math.pow(pos2.z-z,2));
                    } else dummy.rotation.set(Math.PI/2, 0, 0);

                    dummy.scale.set(scaleX, scaleX, dist * zMult * 1.05); dummy.updateMatrix(); cellMesh.setMatrixAt(idx, dummy.matrix);

                    const matrixRemaining = (state.relComp.lig + state.relComp.hem) / 55.0; 
                    if (matrixRemaining > 0.05 && !broken && localPeel < 0.2) {
                        dummy.scale.set(scaleX * (1.0 + matrixRemaining*0.8), scaleX * (1.0 + matrixRemaining*0.8), dist * zMult * 1.2);
                        dummy.updateMatrix(); shellMesh.setMatrixAt(idx, dummy.matrix);
                    } else { dummy.scale.set(0,0,0); dummy.updateMatrix(); shellMesh.setMatrixAt(idx, dummy.matrix); }

                    if (state.postType !== 'none' && state.postDeg > 0 && !broken) {
                        if (((f.id * 19 + j * 23) % 100 / 100) < state.postDeg) {
                            dummy.position.set(x, y, z);
                            const s = state.postType === 'polymer' ? scaleX * 2.5 : scaleX * 1.2;
                            dummy.scale.set(s,s,s); dummy.updateMatrix(); postMesh.setMatrixAt(idx, dummy.matrix);
                        } else { dummy.scale.set(0,0,0); dummy.updateMatrix(); postMesh.setMatrixAt(idx, dummy.matrix); }
                    } else { dummy.scale.set(0,0,0); dummy.updateMatrix(); postMesh.setMatrixAt(idx, dummy.matrix); }

                    idx++;
                }
            }
            cellMesh.instanceMatrix.needsUpdate = true; shellMesh.instanceMatrix.needsUpdate = true; postMesh.instanceMatrix.needsUpdate = true;

            updateAnalytics(effectiveEnergy, staticSwelling);
        }

        function updateAnalytics(effectiveEnergy, staticSwelling) {
            $('stat-zeta').textContent = Math.round(state.zetaPotential) + ' mV';
            const isBlocked = state.relComp.lig > 12;

            if (state.preType === 'enzyme' && state.preDeg >= 0.08) $('warning-box').style.display = 'block';
            else $('warning-box').style.display = 'none';

            let baseTS = 45; let baseYM = 3.5; let baseStrain = 2.0; 
            let app = "Standard paper products, cardboard, packaging. Low nanoscale functionality.";
            let currentMorph = "Intact Wood Fiber"; let currentAspect = 10;

            if (isBlocked && state.energy > 0) {
                currentMorph = "Failed Defibrillation (Recalcitrance)"; currentAspect = 10;
            } else if (effectiveEnergy > 0.8 && state.preType === 'tempo') {
                currentMorph = "TOCNF (Individualized Nanorods)"; currentAspect = 450;
                baseTS = 250; baseYM = 16.0; baseStrain = 4.0;
                app = "High-barrier oxygen packaging, transparent flexible electronics, high-end rheology modifiers.";
            } else if (effectiveEnergy > 0.4 && state.preType === 'enzyme' && state.preDeg >= 0.08) {
                const chopDegree = Math.min(1.0, (state.preDeg - 0.08) * 2.5);
                if (chopDegree > 0.8) {
                    currentMorph = "Cellulose Nanocrystals (CNC)";
                    app = "Iridescent photonic films, strengthening additive for nanocomposites, emulsion stabilizers.";
                } else {
                    currentMorph = "CNF / CNC Mixture (Hydrolyzed)";
                    app = "Rheology modifiers, hybrid structural films, hydrogel networks.";
                }
                currentAspect = Math.round(120 - (95 * chopDegree)); 
                baseTS = 180 - (90 * chopDegree); baseYM = 12.0 + (8.0 * chopDegree); baseStrain = 6.0 - (5.0 * chopDegree); 
            } else if (effectiveEnergy > 0.6 || (state.preType === 'enzyme' && state.preDeg < 0.08 && effectiveEnergy > 0.2)) {
                if(state.mechType === 'grinder' || (state.preType === 'enzyme' && state.preDeg < 0.08)) { 
                    currentMorph = state.preType === 'enzyme' ? "Enzymatic CNF (Flexible)" : "CNF (Entangled Gel Network)"; 
                    currentAspect = 120; baseTS = 180; baseYM = 12.0; baseStrain = 6.0; 
                    app = "Strong nanopaper, hydrogels for tissue engineering, thickeners."; 
                }
                else if(state.mechType === 'super') { currentMorph = "Highly Branched CNF Web"; currentAspect = 35; baseTS = 130; baseYM = 8.0; baseStrain = 8.0; app = "Absorbent materials, aerogel precursors, filtration membranes."; }
                else { currentMorph = "Microfibrillated Cellulose (MFC)"; currentAspect = 60; baseTS = 110; baseYM = 9.0; baseStrain = 4.0; app = "Paper coating, cement additives, low-cost bio-fillers."; }
            } else if (effectiveEnergy > 0.1 || staticSwelling > 0.1) {
                currentMorph = "Partially Delaminated Fiber"; currentAspect = 20;
                baseTS = 70; baseYM = 5.0;
            } else if (state.relComp.lig < 2) {
                currentMorph = "Bleached Cellulose Pulp"; currentAspect = 10;
            }

            if (state.relComp.lig > 5) {
                baseTS -= state.relComp.lig * 2.5; baseStrain += state.relComp.lig * 0.1; 
                app = "Hydrophobic barriers, UV-blocking films, unbleached kraft specialties.";
            }

            if(state.postType === 'laccase' && state.postDeg > 0.1) {
                currentMorph = "DHP Lignin-Grafted " + currentMorph;
                baseTS += 15 * state.postDeg; baseYM += 4.5 * state.postDeg; baseStrain *= (1 - 0.4 * state.postDeg); 
                app = "Antimicrobial active packaging, antioxidant food wraps, hydrophobic structural composites.";
            }
            if(state.postType === 'polymer' && state.postDeg > 0.1) {
                currentMorph = "PVA/PLA " + currentMorph + " Nanocomposite";
                baseTS = baseTS * (1 - state.postDeg * 0.7) + 45 * state.postDeg; 
                baseYM = baseYM * (1 - state.postDeg * 0.8) + 2.5 * state.postDeg; 
                baseStrain = baseStrain * (1 - state.postDeg) + 25.0 * state.postDeg; 
                app = "Fully biodegradable thermoformable plastics, 3D printing filaments, flexible packaging.";
            }
            if(state.postType === 'ions' && state.postDeg > 0.1) {
                currentMorph = "Ionically Modified " + currentMorph;
                baseTS += 40 * state.postDeg; baseYM += 2.0 * state.postDeg; baseStrain *= (1 - 0.2 * state.postDeg);
                app = "High-wet-strength papers, heavy metal adsorption membranes, advanced functional coatings.";
            }

            state.morphology = currentMorph; state.aspect = currentAspect;

            $('stat-morph').textContent = state.morphology;
            $('stat-ar').textContent = "~ " + state.aspect;
            $('stat-ts').textContent = Math.max(10, baseTS).toFixed(1) + " MPa";
            $('stat-ym').textContent = Math.max(1, baseYM).toFixed(1) + " GPa";
            $('stat-strain').textContent = Math.max(0.5, baseStrain).toFixed(1) + " %";
            $('stat-app').textContent = app;
        }

        function loop() { requestAnimationFrame(loop); updatePhysics(); controls.update(); renderer.render(scene, camera); }

        window.onload = () => {
            initScene(); updateComposition(); buildArchitecture(); formatPretreatment(); formatEnergy(); formatPost();
            setTimeout(() => { $('loader').style.opacity = '0'; setTimeout(() => $('loader').remove(), 500); }, 800);
            loop();
        };
    </script>
</body>
</html>


